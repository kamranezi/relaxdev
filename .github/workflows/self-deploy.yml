name: Deploy Dashboard to Yandex

on:
  push:
    branches: [ "main" ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      # 1. –õ–æ–≥–∏–Ω –≤ Docker –Ø–Ω–¥–µ–∫—Å–∞
      - name: Login to Yandex CR
        uses: docker/login-action@v3
        with:
          registry: cr.yandex
          username: json_key
          password: ${{ secrets.YC_SA_KEY_JSON }}

      # 2. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ YC CLI
      - name: Install YC CLI
        run: |
          curl -sSL https://storage.yandexcloud.net/yandexcloud-yc/install.sh | bash
          sudo ln -s /home/runner/yandex-cloud/bin/yc /usr/bin/yc

      # 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è YC
      - name: Authenticate YC CLI
        env:
          YC_KEY: ${{ secrets.YC_SA_KEY_JSON }}
        run: |
          echo "$YC_KEY" > key.json
          yc config profile create sa-profile
          yc config set service-account-key key.json
          yc config set folder-id ${{ secrets.YC_FOLDER_ID }}
          rm -f key.json  # –£–¥–∞–ª—è–µ–º –∫–ª—é—á –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

      # 4. –°–±–æ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ–±—Ä–∞–∑–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–û)
      - name: Build and Push
        env:
          # Build-time –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (NEXT_PUBLIC_*)
          NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
          NEXT_PUBLIC_API_URL: ${{ secrets.NEXTAUTH_URL }}
        run: |
          IMAGE_URI="cr.yandex/${{ secrets.YC_REGISTRY_ID }}/ruvercel-dashboard:${{ github.sha }}"
          
          echo "üî® Building Docker image..."
          docker build \
            --progress=plain \
            --build-arg NEXTAUTH_URL="${NEXTAUTH_URL}" \
            --build-arg NEXT_PUBLIC_API_URL="${NEXT_PUBLIC_API_URL}" \
            -t $IMAGE_URI . 2>&1 | tee build.log
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–æ—Å—Ç–∏ —Å–±–æ—Ä–∫–∏
          if [ ${PIPESTATUS[0]} -ne 0 ]; then
            echo "‚ùå Build failed! Last 50 lines:"
            tail -50 build.log
            exit 1
          fi
          
          echo "üì¶ Pushing image to registry..."
          docker push $IMAGE_URI
          
          echo "IMAGE_URI=$IMAGE_URI" >> $GITHUB_ENV
          echo "‚úÖ Image pushed: $IMAGE_URI"

      # 5. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–ò–°–ü–†–ê–í–õ–ï–ù–û: –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ)
      - name: Deploy Revision
        run: |
          echo "üöÄ Deploying new revision..."
          
          yc serverless container revision deploy \
            --container-name ruvercel-frontend \
            --folder-id ${{ secrets.YC_FOLDER_ID }} \
            --image ${{ env.IMAGE_URI }} \
            --service-account-id ${{ secrets.YC_SA_ID }} \
            --cores 1 \
            --memory 512M \
            --execution-timeout 30s \
            --environment \
              YC_FOLDER_ID=${{ secrets.YC_FOLDER_ID }},\
              YC_REGISTRY_ID=${{ secrets.YC_REGISTRY_ID }},\
              YC_SA_ID=${{ secrets.YC_SA_ID }},\
              GITHUB_ACCESS_TOKEN=${{ secrets.GH_PAT }},\
              BUILDER_REPO_OWNER=kamranezi,\
              BUILDER_REPO_NAME=ruvercel-builder,\
              GITHUB_ID=${{ secrets.GH_OAUTH_ID }},\
              GITHUB_SECRET=${{ secrets.GH_OAUTH_SECRET }},\
              NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }},\
              NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }},\
              NODE_ENV=production
          
          echo "‚úÖ Deployment complete!"

      # 6. –û—á–∏—Å—Ç–∫–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
      - name: Cleanup
        if: always()
        run: |
          rm -f key.json
          docker system prune -f